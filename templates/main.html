<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta property="og:title" content="am·stram·dam" />
<meta property="og:description" content="«à l’endroit où les rives du fleuve perdent leur mine souriante, où monts et rochers avec leurs ruines fantastiques de vieux bourgs prennent un air hautain, plus sauvage, plus grave et plus majestueux, on découvre, pareille à une légende lugubre de l’ancien temps, la vieille et sombre ville de Bacharach.»" />
<meta property="og:image" content="{{ url_for('static',filename='background.png') }}" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>am·stram·dam</title>

    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{{ url_for('static',filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='style.mobile.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='timer.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static',filename='favicon.ico') }}" type="image/x-icon">
    <link rel="icon" href="{{ url_for('static',filename='favicon.ico') }}" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
   integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
   crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script>
    <script src="{{ url_for('static',filename='countUp.js') }}"></script>
    <script src="https://kit.fontawesome.com/0b60c47224.js" crossorigin="anonymous"></script>
    <style>

    </style>
</head>
<body>
<div class="blink-wrapper off" id="blink-wrapper">
    <div class="blink-item" id="left"></div>
    <div class="blink-item" id="right"></div>
    <div class="blink-item" id="top"></div>
    <div class="blink-item" id="bottom"></div>
</div>
<div class="main">
    <div id="game-sharing-link">Inviter des amis: <u id="sharing-link"></u></div>
    <div class="popup-container" id="popup-container" hidden>
        <div id="mask">

        </div>
        <div id="popup" class="box">
            <div class="popup-left">
                <div class="box no-border" id="chat-box-popup">
                <div class="inner-chat">
                    <div id="chat-messages-popup" class="chat-messages">

                    </div>
                    <div class="input">
                        <textarea name="chat-input" id="chat-input-popup" class="chat-input" placeholder="Envoyez un message"></textarea>
                    </div>
                    </div>
                </div>
            </div>
            <div class="popup-main">
                <h2 class="blue">Partie terminée !</h2>
            <table id="final-results">

            </table>
            <button id="relaunch-from-popup">Nouvelle partie</button>
            <div style="margin-top:15px;">
                <a  href="/">Retour à l'accueil</a>
            </div>
            </div>

        </div>
    </div>
        <div class="column" id="left-column-display">


    <div class="box" id="main-info-box">
        <div class="nav">
            <a href="/">Accueil</a>
        </div>
      <div class="self">
      <div class="name" id="player-name">Non connecté</div>
        <div class="total-score"><span id="total-score">0</span> pts</div>
      </div>

      <div class="ranking">
        <ul id="player-list">
        </ul>
        <div class="controls">
          <button id="launch">Commencer</button>
            <i class="fas fa-comments" id="chat-toggle-button"></i>
          <!--<button id="restart">Restart</button>-->
        </div>
      </div>
    </div>

            <div class="box" id="chat-box">
                <i id="close-chatbox" class="fas fa-times"></i>
                <div class="inner-chat">
                    <div id="chat-messages" class="chat-messages">

                    </div>
                    <div class="input">
                        <textarea name="chat-input" id="chat-input" class="chat-input" placeholder="Envoyez un message"></textarea>
                    </div>
                </div>
            </div>


      <div class="box" id="results" hidden>
          <div class="individual-results">
              <div id="answer-name" class="title"></div>
      <div class="distance"><span id="main-disp-dist">0</span> km</div>
      <div class="deets">
        <div class="score-dist"><i id="disp-dist">0</i> km = <i id="disp-score-dist">0</i> pts</div>
        <div class="score-time"><i id="disp-time">0</i>s = <i id="disp-score-time">0</i> pts</div>
          </div>

      </div>

      <div class="score">
          <span id="curr-score">0</span> pts
      </div>

          <div class="collective-results">
                    <ul id="current-results">

                    </ul>
              </div>
    </div>
    </div>

    <div class="right-corner" id="game-box" hidden>
        <div class="game-info box" id="display-hint">
            <span class="run-info">
                <span id="run-current">0</span>/<span id="run-total">0</span>
            </span>
            <span id="target"></span>
            <div class="progress-container">
                <div class="progress-inner">
                <div class="wrapper" id="countdown-animation-wrapper" data-anim="base wrapper">
                  <div class="circle" id="countdown-animation-left" data-anim="base left"></div>
                  <div class="circle" id="countdown-animation-right" data-anim="base right"></div>
                </div>

                </div>
            </div>
        </div>
        <div class="box hidden" id="display-timer">
            <span class="timer-text">Prochaine manche dans <span id="run-timer"></span>...</span>
        </div>
    </div>

    <div id="mapid"></div>
    <!--<audio id="beep" hidden src="{{ url_for('static',filename='bip.mp3') }}"></audio>-->
</div>

<script type="text/javascript" charset="utf-8"  nonce="{{ csp_nonce() }}">
    //import { CountUp } from '{{ url_for('static',filename='countUp.js') }}';
    // import { CountUp} from "../static/countUp";

    const params = {{ params | tojson}};
    document.getElementById("sharing-link").innerHTML = window.location.href;
    const blinkContainer = document.getElementById("blink-wrapper");
    //const audioBeep = document.getElementById("beep");
var hintContainer = document.getElementById("target");
    var playerName = document.getElementById("player-name");
    var playerList = document.getElementById("player-list");
    var scorer = document.getElementById("total-score");
    var gameLauncher = document.getElementById("launch");
    var gameRelauncher = document.getElementById("relaunch-from-popup");
    var gameBox = document.getElementById("game-box");
    var gameHint = document.getElementById("display-hint");
    var gameWaitDisplayer = document.getElementById("display-timer");
    var gameLaunched = false;
    var runLaunched = false;
    var hasAnswered = false;
    var clickable = false;
    var PLAYER;
    var PLAYERS = [];
    var PSEUDOS = {};
    var LEADERBOARD = [];
    updatePlayerList();
    function blink(audio= true){
        const duration = 100; // In millisec
        blinkContainer.classList.remove("off");
        // if (audio) {audioBeep.play();}
        window.setTimeout(() => {
            blinkContainer.classList.add("off");
        }, duration);
    }
    function getIcon(color="red", name="", labelOnly=false, random=false){
        const iconColor = labelOnly ? "transparent" : color;
        const markerHtmlStyles = `
          background: ${iconColor};
          width: 10px;
          height: 10px;
          display: block;
          border-radius: 5px;`;
        var inner;
        if (name) {
            let x = 15;
            let y = 15;
            if (random){
                x = 2* (Math.random()-0.5);
                y = Math.sqrt(1 - Math.pow(x, 2));
                if (Math.random() > 0.5){
                    y = -y;
                }
                x = Math.round((15 + 15*Math.random())*x);
                y = Math.round((15 + 15*Math.random())*y);
            }
            const labelStyle = `
            background-color: ${color};
            color: white;
            padding: 3px;
            top: ${x}px;
            left: ${y}px;
            position: absolute;
            font-family: monospace;
            `;
            inner = `<span class="icon-label" style="${labelStyle}">${name}</span>`;
        }
        else {
            inner = "";
        }

        return L.divIcon({
            className: "my-custom-pin",
            iconAnchor: [5, 5],
            html: `<span class="icon" style="${markerHtmlStyles}">${inner}</span>`
        })
    }
    function getLabelIcon(color="red", name=""){

    }

    function getPlayerName(name){
        return PSEUDOS[name] || name;
    }
    function updatePseudos(pseudos){
        PSEUDOS = pseudos || {};
        updatePlayerList();
    }
    function addPseudo(player, name){
        PSEUDOS[player] = name;
        updatePlayerList();
    }

    var countdownInterval;
    const countdownAnimationElements = ["wrapper", "left", "right"];
    function endCountdown(){
        document.getElementById("countdown-animation-wrapper").hidden = true;
        countdownAnimationElements.forEach(c => {
            let id = `countdown-animation-${c}`;
            let el = document.getElementById(id);
            // console.log(id);
            // console.log(el);
            el.setAttribute("data-anim", "");
        });
    }
    function startCountdown(){
        clearInterval(countdownInterval);
        document.getElementById("countdown-animation-wrapper").hidden = false;
        countdownAnimationElements.forEach(c => {
            let id = `countdown-animation-${c}`;
            let el = document.getElementById(id);
            // console.log(id);
            // console.log(el);
            el.setAttribute("data-anim", `base ${c}`);
        });
        document.getElementById("countdown-animation-wrapper").style.animationDelay = String(params.duration/2) + "s";
        document.getElementById("countdown-animation-left").style.animationDuration = String(params.duration) + "s";
        document.getElementById("countdown-animation-right").style.animationDuration = String(params.duration/2) + "s";
        countdownInterval = setInterval(() => {
            endCountdown();
        }, params.duration*1000);
    }

    let franceZoom = 6;
    let worldZoom = 2;
    let zoom = worldZoom;
    const LAYERS = {
        default: 'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
        alt: 'https://tiles.wmflabs.org/osm-no-labels/{z}/{x}/{y}.png',
        watercolor: 'http://c.tile.stamen.com/watercolor/{z}/{x}/{y}.jpg',
        terrain: 'http://c.tile.stamen.com/terrain-background/{z}/{x}/{y}.jpg',
        bw: 'http://tile.stamen.com/toner-background/{z}/{x}/{y}.png',
        bwSSL: 'https://stamen-tiles.a.ssl.fastly.net/toner-background/{z}/{x}/{y}.png'
    };
    var centerFrance = [46.758162, 2.812324];
    var centerWorld = [23.7, 7.6];
    const game = {
        france: {
            center: centerFrance,
            zoom: franceZoom
        },
        world: {
            center: centerWorld,
            zoom: worldZoom
        },
    };


    const currGame = game; // game.world;
     var map = L.map('mapid'); //.setView(currGame.center, currGame.zoom);
    map.fitBounds(params.bbox);
     mobileCheck = function() {
          let check = false;
          (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
          return check;
        };
     const isMobile = mobileCheck();
     const maxZoom = isMobile ? 6 : currGame.zoom+2;

     var OSM = L.tileLayer(LAYERS.bwSSL, {
	    //maxZoom: currGame.zoom, //maxZoom,
        minZoom: currGame.zoom,
         zoomControl:  false, //false,
	 //attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Tiles style by <a href="https://www.hotosm.org/" target="_blank">Humanitarian OpenStreetMap Team</a> hosted by <a href="https://openstreetmap.fr/" target="_blank">OpenStreetMap France</a>'
     attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
     });
     OSM.addTo(map);
    var spider = new OverlappingMarkerSpiderfier(map);
    var correctionCircle;

     function updatePlayerList(){
         playerList.innerHTML = "";
         LEADERBOARD.forEach(el => {
             if (el.player === PLAYER){
                 scorer.innerHTML = el.score;
                 playerList.innerHTML += `<li><i><span class="pname">${getPlayerName(el.player)}*</span><span class="pscore">${el.score} pts</span></i></li>`
             }
             else {
                playerList.innerHTML += `<li><span class="pname">${getPlayerName(el.player)}</span><span class="pscore">${el.score} pts</span></li>`
             }
         });
     }
     function showResults(){
         let table = "";
       LEADERBOARD.forEach((el, i) => {
           table += `<tr><td class="rank">${i+1}</td><td class="player-name">${getPlayerName(el.player)}</td><td class="player-score">${el.score}pts</td></tr>`
       });
       document.getElementById("final-results").innerHTML = table;
       document.getElementById("popup-container").hidden = false;
     }
     function hideResults(){
       document.getElementById("popup-container").hidden = true;
     }
     function displayGameBox(hint, currRun, totalRun){
        gameBox.hidden = true;
        gameHint.classList.remove("hidden");
         gameWaitDisplayer.classList.add("hidden");
        document.getElementById("run-current").innerHTML = currRun + 1;
        document.getElementById("run-total").innerHTML = totalRun;
        target.innerHTML = hint;
        gameBox.hidden = false;
     }
     function hideGameBox(){
         gameBox.hidden = true;
     }
     function startWaitTimer(){
         gameHint.classList.add("hidden");
         gameWaitDisplayer.classList.remove("hidden");
         gameBox.hidden = false;

         var duration = params.wait_time;
         document.getElementById("run-timer").innerHTML = duration;
         var waitInterval = window.setInterval(() => {
             duration = duration - 1;
             if (duration >= 0) {
                 document.getElementById("run-timer").innerHTML = duration;
             }
             else {
                 window.clearInterval(waitInterval);
             }
         }, 1000); // Update every second

     }

        function addGuessEntry(name, distance){
            // document.getElementById("results").hidden = false;
            showRunResults();
            var resultContainer = document.getElementById("current-results");
            distance = Math.round(distance);
            resultContainer.innerHTML += `<li><span class="pname">${getPlayerName(name)}</span><span class="pscore">${distance}km</span></li>`;
        }
        function clearGuessEntries(){
            document.getElementById("current-results").innerHTML = "";
        }
    function makeAnimatedCircle(lat, lon, radius, color, onEnd){
         var newRadius = radius*1000; // Kilometres to meters
         let circle = L.circle([lat, lon], {
                color: color,
                // fillColor: color,
                // fillOpacity: 0.1,
                radius: 0.01
            });
         circle.addTo(map);
         let duration = 400;
         let timestep = 5;
         let step = newRadius / timestep;
        //return;

        var interval = setInterval(function() {
           var currentRadius = circle.getRadius();
           console.debug("currentRadius", currentRadius);
           if (currentRadius < newRadius) {
               circle.setRadius(currentRadius + step);
               //console.debug("new Radius", correctionCircle.getRadius());
           } else {
               clearInterval(interval);
               if (onEnd){
                onEnd();

               }
           }
        }, timestep);

        return circle;
    }
    function showRunResults(){
         const container = document.getElementById("left-column-display");
         if (!container.classList.contains("with-results")){
             container.classList.add("with-results");
         }
         document.getElementById("results").hidden = false;
    }
    function hideRunResults(){
         const container = document.getElementById("left-column-display");
         if (container.classList.contains("with-results")){
             container.classList.remove("with-results");
         }
         document.getElementById("results").hidden = true;
    }
    const blinkDelay = 3; // In seconds: screen will blink `blinkDelay` seconds before run end
    const blinkTimestep = 500; // In milliseconds
    var blinkTimeout;
    var blinkInterval;
    console.log(window.location);
        var socket = io(window.location, {secure: true});
        socket.on('connect', function() {
            console.log("Connecting...");
            socket.emit('connection', {data: 'I\'m connected!'});
        });
        socket.on('disconnect', function() {
            console.log("Disconnecting...");
        });
        socket.on('redirect', function (data) {
            console.log(`Redirecting to ${data.url}...`);
            window.location.href = data.url;
        })
        socket.on("log", function(data){
            console.log(data);
        });
        socket.on("game-launched", (data) => {
            console.log("Received: game launched");
            hideResults();
            gameLaunched = true;
            gameLauncher.disabled = true;
        });
        socket.on("game-end", (data) => {
           console.log("Game ended!");
           LEADERBOARD = data.leaderboard;
           updatePlayerList();
           showResults();
           gameLaunched = false;
        });
        socket.on("marker", function(data){
            var name = data.name || "";
            var color = data.color || "red";
            addMarker(data.lat, data.lon, name, color)
        });
        socket.on("run-start", (data) => {
            runLaunched = true;
            console.log(`Run started, place to find is «${data.hint}»`);
            clearMap();
            clearGuessEntries();
            hideRunResults();
            startCountdown();
            hasAnswered = false;
            //document.getElementById("results").hidden = true;
            displayGameBox(data.hint, data.current, data.total);

            /*gameBox.hidden = true;
            document.getElementById("results").hidden = true;
            document.getElementById("run-current").innerHTML = data.current+1;
            document.getElementById("run-total").innerHTML = data.total;
            target.innerHTML = data.hint;
            gameBox.hidden = false;*/

            blinkTimeout = window.setTimeout(() => {
                console.log(`${blinkDelay} seconds remaining...`);
                blinkInterval = window.setInterval(() => {
                    blink(false);
                }, blinkTimestep);
            }, 1000*(params.duration - blinkDelay));
        });
        socket.on("new-guess", (data) => {
            //console.log(data);
            addGuessEntry(data.player, data.dist);
        });
        socket.on("score", (data) => {
            addMarker(data.answer.lat, data.answer.lon, data.answer.name, "blue");
            makeAnimatedCircle(data.answer.lat, data.answer.lon, data.dist, "red");
            scorer.innerHTML = data.score;
            const dist = Math.round(data.dist);
            const score = Math.round(data.score);

            document.getElementById("answer-name").innerHTML = data.answer.name;
            document.getElementById("main-disp-dist").innerHTML = 0; //dist; // Math.round(data.dist);
            document.getElementById("disp-dist").innerHTML = 0; //dist; // Math.round(data.dist);
            document.getElementById("disp-score-dist").innerHTML = 0; //Math.round(data.sd);
            document.getElementById("disp-time").innerHTML = 0; //Math.round(data.delta * 100) / 100;
            document.getElementById("disp-score-time").innerHTML = 0; // Math.round(data.st);
            document.getElementById("curr-score").innerHTML = 0; //score; //data.score;
            document.getElementById("results").hidden = false;

            const distanceCounter = new CountUp('main-disp-dist', dist, {separator: ""});
            distanceCounter.start();
            const scoreCounter = new CountUp('curr-score', score, {separator: ""});

            scoreCounter.start();

            const secDistCounter =  new CountUp("disp-dist", Math.round(data.dist));
            secDistCounter.start();
            const sdCounter =  new CountUp("disp-score-dist", Math.round(data.sd));
            sdCounter.start();
            const timeCounter =  new CountUp("disp-time", Math.round(data.delta * 100)/100);
            timeCounter.start();
            const stCounter =  new CountUp("disp-score-time", Math.round(data.st));
            stCounter.start();
        });
        socket.on("init", (data)=> {
            console.log(`You're now connected as <${data.player}>`);
            var pseudo = getPseudoFromCookie();
            PLAYER = data.player;
            updatePseudos(data.pseudos);
            if (pseudo) {
                console.log(PLAYER, "has requested a new pseudo", pseudo);
                socket.emit("name-change", {name: pseudo});
                addPseudo(PLAYER, pseudo);
            }
            playerName.innerHTML = getPlayerName(PLAYER);
            playerName.contentEditable = true;
            gameLaunched = data.launched;
            if (gameLaunched) {
                gameLauncher.disabled = true;
            }
        });
        socket.on("new-name", (data) => {
            console.log(`Player <${data.change.player}> has a new nickname: "${data.change.pseudo}"`);
            updatePseudos(data.pseudos);
        })
        socket.on("new-player", (data) => {
            console.log("Welcome", data.player);
            LEADERBOARD = data.leaderboard;
            updatePlayerList();
        });
        socket.on("player-left", (data) => {
            console.log("Bye,", data.player);
            LEADERBOARD = data.leaderboard;
            updatePlayerList();
        });
        socket.on("run-end", (data) => {
            endCountdown();
            runLaunched = false;
            window.clearInterval(blinkInterval);
            window.clearTimeout(blinkTimeout);
            startWaitTimer();
            clearMap();
            LEADERBOARD = data.leaderboard;
            updatePlayerList();
            displayRun(data);
        });
    function displayRun(data){
        const trueLon = data.answer.lon;
        const trueLat = data.answer.lat;
        var nAnswers = data.results.length;
        const originalCenter = map.getCenter();
        const originalZoom = map.getZoom();
        const originalMaxZoom = map.getMaxZoom();
        var trueAnswer = addMarker(data.answer.lat, data.answer.lon, data.answer.name, "blue");
        var answers = L.featureGroup([trueAnswer]).addTo(map);
        let requests = data.results.map((rec) => {
            return new Promise((resolve) => {
                let col = (rec.player === PLAYER) ? "red" : "purple";
                makeAnimatedCircle(trueLat, trueLon, rec.dist || 10, col, () => {
                    let marker = addMarker(rec.guess.lat, rec.guess.lon, getPlayerName(rec.player), col);
                    answers.addLayer(marker);
                    resolve();
                });
            });
        });
        const ANIM_DURATION = 0.5;
        const DELTA_PAD = 0.5;
        Promise.all(requests).then(() => {
            if (nAnswers > 0){
                let bounds = answers.getBounds().pad(0.5);
                let tempZoom = OSM.maxNativeZoom || 8;
                // map.setMaxZoom(tempZoom);
                //OSM.maxZoom = tempZoom;
                map.flyToBounds(bounds, {duration: ANIM_DURATION});
            }
        });
        if (nAnswers > 0){
            window.setTimeout(() => {
                map.flyTo(originalCenter, originalZoom, {duration: ANIM_DURATION});
                map.setMaxZoom(originalMaxZoom);
                //OSM.maxZoom  = originalMaxZoom;
            }, (params.wait_time-2*ANIM_DURATION - DELTA_PAD)*1000);
        }
        /*data.results.forEach(rec => {
            let col = (rec.player === PLAYER) ? "red" : "purple";
            makeAnimatedCircle(trueLat, trueLon, rec.dist || 10, col, () => {
                let marker = addMarker(rec.guess.lat, rec.guess.lon, rec.player, col);
                answers.addLayer(marker);
            });
            console.log(answers);
        })*/
    }
    function savePseudoToCookie(value){
        value = encodeURIComponent(value);
        var expires = ";max-age=31536000";
        document.cookie = "amstramdamUsername=" + value + expires;
    }
    function getPseudoFromCookie(){
        var cookieValue = document.cookie.replace(/(?:(?:^|.*;\s*)amstramdamUsername\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        cookieValue = decodeURIComponent(cookieValue);
        return cookieValue;
    }
    playerName.addEventListener("keydown", (e) => {
        if (e.keyCode === 13){
            playerName.blur();
        }
        if (playerName.innerHTML.length >= 20){
            e.preventDefault();
        }
    });
    playerName.addEventListener("click", (e) => {
        //playerName.focus();
        e.stopPropagation();
    });
    playerName.addEventListener("focusout", (e) => {
        const newName = playerName.innerHTML;
        if (!newName){
            // Empty name
            playerName.innerHTML = PLAYER;
            return;
        }
        if (newName !== PLAYER){
            console.log(PLAYER, "has requested a new pseudo", newName);
            socket.emit("name-change", {name: newName});
            savePseudoToCookie(newName);
        }
    });
    gameLauncher.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (!gameLaunched){
            socket.emit("launch");
        }
    });
    gameRelauncher.addEventListener("click", (e) => {
        console.log("Relaunching...");
        e.preventDefault();
        if (!gameLaunched){
            socket.emit("launch");
        }
    });
     function addMarker(lat, lon, name="", color="red", openPopup=false){
         var marker = L.marker([lat, lon], {icon: getIcon(color, name)}).addTo(map);
         //var labelMarker = L.marker([lat, lon], {icon: getIcon(color, name, true)}).addTo(map);
         spider.addMarker(marker);
         return marker;
     }
     function addGuess(guess, answer, name, color="red", popup=true){
         //addMarker(answer.lat, answer.lon, "", "blue");
        L.polyline(
            [
                [guess.lat, guess.lon],
                [answer.lat, answer.lon]
            ]).addTo(map);
        let marker = addMarker(guess.lat, guess.lon);
        if (popup){
            marker.bindPopup(name).openPopup();
        }
     }
    function clearMap(excludeLayers=[]){
        map.eachLayer(function (layer) {
            if (layer !== OSM &&  layer !== correctionCircle ){ //!excludeLayers.includes(layer)){
                map.removeLayer(layer);
            }
        });
    }
    function sendMessage(){
        let data = {};
        socket.emit("json", {data: data});
    }
    function onMapClick(e) {
        if (!runLaunched || hasAnswered){
            //console.log("Can't click, clickable=false");
            return
        }
        let coords = e.latlng;
        let data = {
                lon: coords.lng,
                lat: coords.lat,
                player: PLAYER
            };
        //console.log(PLAYER);
        //console.log(data);
        addMarker(coords.lat, coords.lng, getPlayerName(PLAYER));
        socket.emit("guess", data);
        hasAnswered = true;
        clickable = false;
    }
    const mainInfoBox = document.getElementById("main-info-box");
        mainInfoBox.addEventListener("click", () => {
        if (mainInfoBox.classList.contains("toggled")){
            mainInfoBox.classList.remove("toggled");
        } else {
            mainInfoBox.classList.add("toggled");
        }
    });

        /* CHAT SUPPORT */
    var chatInput = document.getElementById("chat-input");
    var chatMessages = document.getElementById("chat-messages");
    var chatInput2 = document.getElementById("chat-input-popup");
    var chatMessages2 = document.getElementById("chat-messages-popup");

    function appendMessage(message, author){
            var el = `<div class="chat-message"><span class="chat-author">${getPlayerName(author)}</span><span class="chat-message-content">${message}</span></div>`;
        chatMessages.innerHTML += el;
        chatMessages2.innerHTML += el;
    }
    chatInput.addEventListener("keyup", (e) => {
        if (e.keyCode === 13){
            var message = chatInput.value;
            socket.emit("chat:send", message);
            chatInput.value = "";
            appendMessage(message, PLAYER);
        }
    });
    chatInput2.addEventListener("keyup", (e) => {
        if (e.keyCode === 13){
            var message = chatInput2.value;
            socket.emit("chat:send", message);
            chatInput2.value = "";
            appendMessage(message, PLAYER);
        }
    });

    socket.on("chat:new", (data) => {
        if (data.author !== PLAYER){
            appendMessage(data.message, data.author);
        }
    });

    document.getElementById("chat-toggle-button").addEventListener("click", () => {
        document.getElementById("chat-box").classList.toggle("hidden");
    });

    document.getElementById("close-chatbox").addEventListener("click", () => {
        document.getElementById("chat-box").classList.add("hidden");
    })

    map.on('click', onMapClick);
    </script>
</body>
</html>